/*!
 * maptalks.markercluster v2.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function r(t,e){for(var r=Object.getOwnPropertyNames(e),o=0;o<r.length;o++){var n=r[o],i=Object.getOwnPropertyDescriptor(e,n);i&&i.configurable&&void 0===t[n]&&Object.defineProperty(t,n,i)}return t}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}var s={maxClusterRadius:160,geometryEvents:!1,symbol:null,drawClusterText:!0,textSymbol:null,animation:!0,animationDuration:450,maxClusterZoom:null},a=function(t){function r(){return o(this,r),n(this,t.apply(this,arguments))}return i(r,t),r.fromJSON=function(t){if(!t||"ClusterLayer"!==t.type)return null;for(var o=new r(t.id,t.options),n=t.geometries,i=[],s=0;s<n.length;s++){var a=e.Geometry.fromJSON(n[s]);a&&i.push(a)}return o.addGeometry(i),o},r.prototype.onConfig=function(e){return e.hasOwnProperty("symbol")&&this._getRenderer()&&this._getRenderer().onSymbolChanged(),t.prototype.onConfig.call(this,e)},r.prototype.addMarker=function(t){return this.addGeometry(t)},r.prototype.addGeometry=function(r){for(var o=0,n=r.length;o<=n;o++)if(!r[o]instanceof e.Marker)throw new Error("Only a point(Marker) can be added into a ClusterLayer");return t.prototype.addGeometry.apply(this,arguments)},r.prototype.identify=function(t,e){return this._getRenderer()?this._getRenderer().identify(t,e):null},r.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.type="ClusterLayer",e},r}(e.VectorLayer);a.mergeOptions(s),a.registerJSONType("ClusterLayaer");var u={textFaceName:'"microsoft yahei"',textSize:16},p={markerType:"ellipse",markerFill:{property:"count",type:"interval",stops:[[0,"rgb(135, 196, 240)"],[9,"#1bbc9b"],[99,"rgb(216, 115, 149)"]]},markerFillOpacity:.7,markerLineOpacity:1,markerLineWidth:3,markerLineColor:"#fff",markerWidth:{property:"count",type:"interval",stops:[[0,40],[9,60],[99,80]]},markerHeight:{property:"count",type:"interval",stops:[[0,40],[9,60],[99,80]]}};a.registerRenderer("canvas",function(t){function r(e){o(this,r);var i=n(this,t.call(this,e));return i._animated=!0,i._refreshStyle(),i._clusterNeedRedraw=!0,i}return i(r,t),r.prototype.checkResources=function(){var r=t.prototype.checkResources.apply(this,arguments),o=e.Util.getExternalResources(this.layer.options.symbol||p,!0);return o&&r.push.apply(r,o),r},r.prototype.draw=function(){this.canvas||this.prepareCanvas();var r=this.getMap(),o=r.getZoom(),n=this.layer.options.maxClusterZoom;if(n&&o>n)return delete this._currentClusters,this._markersToDraw=this.layer._geoList,void t.prototype.draw.apply(this,arguments);this._clusterNeedRedraw&&(this._clearDataCache(),this._computeGrid(),this._clusterNeedRedraw=!1);var i=this._clusterCache[o]?this._clusterCache[o].clusters:null;this._markersToDraw=[];var s,a,u,p,c,l,h=r.getContainerExtent(),y=[];for(var d in i)if(this._currentGrid=i[d],1!==i[d].count)u=this._getSprite(),p=u.canvas.width,c=u.canvas.height,s=r._prjToContainerPoint(i[d].center),a=new e.PointExtent(s.substract(p,c),s.add(p,c)),h.intersects(a)&&(l=e.StringUtil.getFont(this._textSymbol),i[d].textSize||(i[d].textSize=e.StringUtil.stringLength(i[d].count,l).toPoint()._multi(.5)),y.push(i[d]));else{var _=i[d].children[0];_._cluster=i[d],this._markersToDraw.push(_)}this._drawLayer(y)},r.prototype._forEachGeo=function(t,e){this._markersToDraw&&this._markersToDraw.forEach(function(r){e?t.call(e,r):t(r)})},r.prototype.drawOnZooming=function(){this._currentClusters&&this._drawClusters(this._currentClusters,1),t.prototype.drawOnZooming.apply(this,arguments)},r.prototype.onGeometryAdd=function(){this._clusterNeedRedraw=!0,this.render()},r.prototype.onGeometryRemove=function(){this._clusterNeedRedraw=!0,this.render()},r.prototype.onGeometryPositionChange=function(){this._clusterNeedRedraw=!0,this.render()},r.prototype.onRemove=function(){this._clearDataCache()},r.prototype.transform=function(t){return this._currentClusters&&this._drawClusters(this._currentClusters,1,t),!0},r.prototype.identify=function(t){var e=this.getMap();if(t=e._pointToContainerPoint(t),!this._currentClusters)return null;for(var r=this._currentGrid,o=0;o<this._currentClusters.length;o++){var n=this._currentClusters[o],i=e._prjToContainerPoint(n.center);this._currentGrid=n;var s=this._getSprite().canvas.width;if(t.distanceTo(i)<=s)return{center:e.getProjection().unproject(n.center.copy()),children:n.children.slice(0)}}return this._currentGrid=r,null},r.prototype.onSymbolChanged=function(){this._refreshStyle(),this._computeGrid(),this._stopAnim(),this.draw()},r.prototype.isUpdateWhenZooming=function(){return!0},r.prototype._refreshStyle=function(){var t=this,r=this.layer.options.symbol||p,o=this.layer.options.textSymbol||u,n=function(){return[t.getMap().getZoom(),t._currentGrid]};this._symbol=e.MapboxUtil.loadFunctionTypes(r,n),this._textSymbol=e.MapboxUtil.loadFunctionTypes(o,n)},r.prototype._drawLayer=function(t){var r=this;this._currentClusters=t,delete this._clusterMaskExtent;var o=this.layer;o.options.animation&&this._animated&&"out"===this._inout?(this._player=e.animation.Animation.animate({d:[0,1]},{speed:o.options.animationDuration,easing:"inAndOut"},function(e){"finished"===e.state.playState?(r._drawMarkers(),r.completeRender()):(r._drawClusters(t,e.styles.d),r.requestMapToRender())}).play(),this._drawClusters(t,0),this.requestMapToRender()):(this._animated=!1,this._drawClusters(t,1),this._drawMarkers(),this.completeRender())},r.prototype._drawMarkers=function(){t.prototype._drawGeos.call(this,this._clusterMaskExtent),this._isBlank=!1},r.prototype._drawClusters=function(t,e,r){var o=this;r=r?r.container:null,this._clusterMaskExtent=this.prepareCanvas();var n=this.getMap(),i={};this.layer.options.animation&&e<1&&t.forEach(function(t){if(t.parent){var s=n._prjToContainerPoint(t.parent.center);i[t.parent.key]||(r&&(s=r.applyToPointInstance(s)),i[t.parent.key]=1,o._drawCluster(s,t.parent,1-e))}}),0!==e&&t.forEach(function(t){var i=n._prjToContainerPoint(t.center);if(t.parent){var s=n._prjToContainerPoint(t.parent.center);i=s.add(i.substract(s)._multi(e))}r&&(i=r.applyToPointInstance(i)),o._drawCluster(i,t,e>.5?1:e)})},r.prototype._drawCluster=function(t,r,o){this._currentGrid=r;var n=this.context,i=this._getSprite(),s=n.globalAlpha;if(s*o!==0){if(n.globalAlpha=s*o,i){var a=t.add(i.offset)._substract(i.canvas.width/2,i.canvas.height/2);n.drawImage(i.canvas,a.x,a.y)}this.layer.options.drawClusterText&&r.textSize&&(e.Canvas.prepareCanvasFont(n,this._textSymbol),e.Canvas.fillText(n,r.count,t.substract(r.textSize))),n.globalAlpha=s}},r.prototype._getSprite=function(){this._spriteCache||(this._spriteCache={});var t=e.Util.getSymbolStamp(this._symbol);return this._spriteCache[t]||(this._spriteCache[t]=new e.Marker([0,0],{symbol:this._symbol})._getSprite(this.resources,this.getMap().CanvasClass)),this._spriteCache[t]},r.prototype._initGridSystem=function(){var t,e,r=[];this.layer.forEach(function(o){e=o._getPrjCoordinates(),t=t?t._combine(o._getPrjExtent()):o._getPrjExtent(),r.push({x:e.x,y:e.y,id:o._getInternalId(),geometry:o})}),this._markerExtent=t,this._markerPoints=r},r.prototype._computeGrid=function(){var t=this.getMap(),e=t.getZoom();this._markerExtent||this._initGridSystem(),this._clusterCache||(this._clusterCache={});var r=t._getResolution(t.getMinZoom())>t._getResolution(t.getMaxZoom())?e-1:e+1;this._clusterCache[r]&&this._clusterCache[r].length===this.layer.getCount()&&(this._clusterCache[e]=this._clusterCache[r]),this._clusterCache[e]||(this._clusterCache[e]=this._computeZoomGrid(e))},r.prototype._computeZoomGrid=function(t){if(!this._markerExtent)return null;var r=this.getMap(),o=r._getResolution(t)*this.layer.options.maxClusterRadius,n=this._clusterCache[t-1],i=r._getResolution(t-1)?r._getResolution(t-1)*this.layer.options.maxClusterRadius:null;!n&&t-1>=r.getMinZoom()&&(this._clusterCache[t-1]=n=this._computeZoomGrid(t-1));for(var s,a,u,p,c,l,h=this._markerPoints,y={},d=this._markerExtent.getMin(),_=0,m=h.length;_<m;_++)s=Math.floor((h[_].x-d.x)/o),a=Math.floor((h[_].y-d.y)/o),u=s+"_"+a,y[u]?(y[u].sum._add(new e.Coordinate(h[_].x,h[_].y)),y[u].count++,y[u].center=y[u].sum.multi(1/y[u].count),y[u].children.push(h[_].geometry)):(y[u]={sum:new e.Coordinate(h[_].x,h[_].y),center:new e.Coordinate(h[_].x,h[_].y),count:1,children:[h[_].geometry],key:u+""},i&&n&&(p=Math.floor((h[_].x-d.x)/i),c=Math.floor((h[_].y-d.y)/i),l=p+"_"+c,y[u].parent=n.clusterMap[l]));return this._mergeClusters(y,o/2)},r.prototype._mergeClusters=function(t,e){var r,o={};for(r in t)o[r]=t[r];var n,i,s={},a={};for(r in t)if(n=t[r],!a[n.key])for(var u=n.key.split("_"),p=+u[0],c=+u[1],l=-1;l<=1;l++)for(var h=-1;h<=1;h++)if(0!==l||0!==h){var y=p+l+"_"+(c+h);i=t[y],i&&this._distanceTo(n.center,i.center)<=e&&(s[n.key]||(s[n.key]=[]),s[n.key].push(i),a[i.key]=1)}for(var d in s){var _=t[d];if(_){for(var m=s[d],f=0;f<m.length;f++)t[m[f].key]&&(_.sum._add(m[f].sum),_.count+=m[f].count,_.children.concat(m[f].geometry),o[m[f].key]=_,delete t[m[f].key]);_.center=_.sum.multi(1/_.count)}}return{clusters:t,clusterMap:o}},r.prototype._distanceTo=function(t,e){var r=t.x-e.x,o=t.y-e.y;return Math.sqrt(r*r+o*o)},r.prototype._stopAnim=function(){this._player&&"finished"!==this._player.playState&&this._player.cancel()},r.prototype.onZoomStart=function(e){this._inout=e.from>e.to?"in":"out",this._stopAnim(),t.prototype.onZoomStart.call(this,e)},r.prototype.onZoomEnd=function(){this._animated=!0,this._computeGrid(),t.prototype.onZoomEnd.apply(this,arguments)},r.prototype._clearDataCache=function(){this._stopAnim(),delete this._markerExtent,delete this._markerPoints,delete this._clusterCache},r}(e.renderer.VectorLayerCanvasRenderer)),t.ClusterLayer=a,Object.defineProperty(t,"__esModule",{value:!0})});